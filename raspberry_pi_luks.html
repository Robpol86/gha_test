<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      property="article:modified_time"
      content="2022-01-23T01:28:06+00:00"
    />
    <meta property="og:title" content="Raspberry Pi LUKS Root Encryption" />

    <meta property="og:type" content="website" />

    <meta
      property="og:url"
      content="https://rob86stage.robpol86.com/raspberry_pi_luks.html"
    />

    <meta property="og:site_name" content="Robpol86.com" />

    <meta
      property="og:description"
      content="In this short guide I’ll go over how I implemented full disk encryption using LUKS on my Raspberry Pi’s root file system without needing a second Linux computer to run commands on. All you need is your Raspberry Pi running Raspbian and a USB flash drive. An overview of the process: Install softwa..."
    />

    <meta
      property="og:image"
      content="https://rob86stage.robpol86.com/_static/logo.png"
    />

    <meta property="og:image:alt" content="Robpol86.com" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="twitter:domain" content="rob86stage.robpol86.com" />
    <title>Raspberry Pi LUKS Root Encryption &#8212; Robpol86.com</title>

    <link href="_static/css/theme.css" rel="stylesheet" />
    <link
      href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="_static/vendor/fontawesome/5.13.0/css/all.min.css"
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin
      href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2"
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin
      href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2"
    />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2"
    />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/background_image.css"
    />
    <link rel="stylesheet" type="text/css" href="_static/fixes.css" />

    <link
      rel="preload"
      as="script"
      href="_static/js/index.be7d3bbb2ef33a8344ce.js"
    />

    <script
      data-url_root="./"
      id="documentation_options"
      src="_static/documentation_options.js"
    ></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <script src="_static/disqus.js"></script>
    <link
      rel="canonical"
      href="https://rob86stage.robpol86.com/raspberry_pi_luks.html"
    />

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link
      rel="next"
      title="Setting Up a Home Root CA"
      href="root_certificate_authority.html"
    />
    <link
      rel="prev"
      title="Installing Windows 11 on a Mac"
      href="windows_11_mac.html"
    />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-touch-icon.png?v=210604"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon-32x32.png?v=210604"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon-16x16.png?v=210604"
    />
    <link rel="manifest" href="/site.webmanifest?v=210604" />
    <link
      rel="mask-icon"
      href="/safari-pinned-tab.svg?v=210604"
      color="#7c7c7c"
    />
    <link rel="shortcut icon" href="/favicon.ico?v=210604" />
    <meta name="apple-mobile-web-app-title" content="Robpol86.com" />
    <meta name="application-name" content="Robpol86.com" />
    <meta name="msapplication-TileColor" content="#00a300" />
    <meta name="theme-color" content="#ffffff" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />

    <!-- Google Analytics -->
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    <div class="container-fluid" id="banner"></div>

    <div class="container-xl">
      <div class="row">
        <!-- Checkboxes to toggle the left sidebar -->
        <input
          type="checkbox"
          class="sidebar-toggle"
          name="__navigation"
          id="__navigation"
          aria-label="Toggle navigation sidebar"
        />
        <label class="overlay" for="__navigation">
          <div class="visually-hidden">Toggle navigation sidebar</div>
        </label>
        <div
          class="col-12 col-md-3 bd-sidebar site-navigation"
          id="site-navigation"
        >
          <div class="navbar-brand-box">
            <a class="navbar-brand text-wrap" href="index.html">
              <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->

              <img src="_static/logo.svg" class="logo" alt="logo" />
            </a>
          </div>
          <form
            class="bd-search d-flex align-items-center"
            action="search.html"
            method="get"
          >
            <i class="icon fas fa-search"></i>
            <input
              type="search"
              class="form-control"
              name="q"
              id="search-input"
              placeholder="Search the docs ..."
              aria-label="Search the docs ..."
              autocomplete="off"
            />
          </form>
          <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
            <div class="bd-toc-item active">
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Projects </span>
              </p>
              <ul class="nav bd-sidenav">
                <li class="toctree-l1">
                  <a class="reference internal" href="vw_alltrack_2019.html">
                    Golf Alltrack SE
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="mib2_comp_media.html">
                    MIB2 Composition Media Hacking
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="3d_printer_mpms2.html">
                    Monoprice Maker Select v2
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="franklin_t9.html">
                    T-Mobile Franklin T9 Hacking
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="photo_albums.html">
                    Photo Albums
                  </a>
                </li>
              </ul>
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Tutorials </span>
              </p>
              <ul class="current nav bd-sidenav">
                <li class="toctree-l1">
                  <a class="reference internal" href="windows_11_mac.html">
                    Installing Windows 11 on a Mac
                  </a>
                </li>
                <li class="toctree-l1 current active">
                  <a class="current reference internal" href="#">
                    Raspberry Pi LUKS Root Encryption
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="root_certificate_authority.html"
                  >
                    Setting Up a Home Root CA
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="raspberry_pi_project_fi.html"
                  >
                    Raspberry Pi on Project Fi
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="postfix_gmail_forwarding.html"
                  >
                    Postfix and Gmail Forwarding
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="bareos_tape_backup.html">
                    Bareos Tape Backup on a 124T
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="flash_droid_cricket.html">
                    Flashing Motorola Droid to Cricket
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="rns_510_vim.html">
                    US RNS-510 Video In Motion
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="imagecfg.html">
                    ImageCFG
                  </a>
                </li>
              </ul>
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Archived Projects </span>
              </p>
              <ul class="nav bd-sidenav">
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="wireless_charging_car_dock.html"
                  >
                    Wireless Charging Car Dock
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="atrix_lapdock.html">
                    Atrix Lapdock Other Uses
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="vw_jsw_2010.html">
                    Jetta SportWagen TDI
                  </a>
                </li>
              </ul>
            </div>
          </nav>
          <!-- To handle the deprecated key -->

          <div class="navbar_extra_footer">
            <p>
              <a href="/genindex.html">Tags</a> |
              <a href="/sitemap.xml">Sitemap</a><br />Generator:
              <a href="https://www.sphinx-doc.org/">Sphinx</a><br />Theme:
              <a href="https://sphinx-book-theme.readthedocs.io/"
                >Sphinx Book Theme</a
              ><br />Host:
              <a href="https://www.nearlyfreespeech.net/"
                >NearlyFreeSpeech.NET</a
              ><br />License:
              <a
                href="https://github.com/Robpol86/robpol86.com/blob/main/LICENSE"
                >BSD-2-Clause</a
              ><br />
            </p>
          </div>
        </div>

        <!-- This is an invisible pixel that we watch to see if we've scrolled. -->
        <div class="sbt-scroll-pixel-helper"></div>
        <main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
          <div class="topbar container-xl fixed-top">
            <div class="topbar-contents row">
              <div
                class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"
              ></div>
              <div class="col pl-md-4 topbar-main">
                <div class="topbar-left">
                  <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                  </label>
                </div>

                <div class="dropdown-buttons-trigger">
                  <button
                    id="dropdown-buttons-trigger"
                    class="btn btn-secondary topbarbtn"
                    aria-label="Download this page"
                  >
                    <i class="fas fa-download"></i>
                  </button>

                  <div class="dropdown-buttons">
                    <!-- ipynb file if we had a myst markdown file -->

                    <!-- Download raw file -->
                    <a class="dropdown-buttons" href="_sources/"
                      ><button
                        type="button"
                        class="btn btn-secondary topbarbtn"
                        title="Download source file"
                        data-toggle="tooltip"
                        data-placement="left"
                      >
                        .rst
                      </button></a
                    >
                    <!-- Download PDF via print -->
                    <button
                      type="button"
                      id="download-print"
                      class="btn btn-secondary topbarbtn"
                      title="Print to PDF"
                      onclick="printPdf(this)"
                      data-toggle="tooltip"
                      data-placement="left"
                    >
                      .pdf
                    </button>
                  </div>
                </div>

                <!-- GitHub link -->

                <a
                  class="edit-button"
                  href="https://github.com/Robpol86/robpol86.com/blob/main/docs/raspberry_pi_luks.rst"
                >
                  <button
                    type="button"
                    class="btn btn-secondary topbarbtn"
                    data-toggle="tooltip"
                    data-placement="bottom"
                    aria-label="Edit this page"
                    title="Edit this page"
                  >
                    <i class="fab fa-github"></i>
                  </button>
                </a>

                <!-- Full screen (wrap in <a> to have style consistency -->

                <a class="full-screen-button"
                  ><button
                    type="button"
                    class="btn btn-secondary topbarbtn"
                    data-toggle="tooltip"
                    data-placement="bottom"
                    onclick="toggleFullScreen()"
                    aria-label="Fullscreen mode"
                    title="Fullscreen mode"
                  >
                    <i class="fas fa-expand"></i></button
                ></a>

                <!-- Launch buttons -->
              </div>

              <!-- Table of contents -->
              <div class="d-none d-md-block col-md-2 bd-toc show noprint">
                <div class="tocsection onthispage pt-5 pb-3">
                  <i class="fas fa-list"></i> Contents
                </div>
                <nav id="bd-toc-nav" aria-label="Page">
                  <ul class="visible nav section-nav flex-column">
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#install-software"
                      >
                        Install Software
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#prepare-boot-files"
                      >
                        Prepare Boot Files
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#shrink-and-encrypt"
                      >
                        Shrink and Encrypt
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#pretty-password-prompt"
                      >
                        Pretty Password Prompt
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a class="reference internal nav-link" href="#references">
                        References
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a class="reference internal nav-link" href="#comments">
                        Comments
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div id="main-content" class="row">
            <div class="col-12 col-md-9 pl-md-3 pr-md-0">
              <!-- Table of contents that is only displayed when printing the page -->
              <div id="jb-print-docs-body" class="onlyprint">
                <h1>Raspberry Pi LUKS Root Encryption</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                  <div id="jb-print-toc">
                    <div>
                      <h2>Contents</h2>
                    </div>
                    <nav aria-label="Page">
                      <ul class="visible nav section-nav flex-column">
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#install-software"
                          >
                            Install Software
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#prepare-boot-files"
                          >
                            Prepare Boot Files
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#shrink-and-encrypt"
                          >
                            Shrink and Encrypt
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#pretty-password-prompt"
                          >
                            Pretty Password Prompt
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#references"
                          >
                            References
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#comments"
                          >
                            Comments
                          </a>
                        </li>
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>

              <div>
                <div class="section" id="raspberry-pi-luks-root-encryption">
                  <span id="raspberry-pi-luks"></span>
                  <h1>
                    Raspberry Pi LUKS Root Encryption<a
                      class="headerlink"
                      href="#raspberry-pi-luks-root-encryption"
                      title="Permalink to this headline"
                      >¶</a
                    >
                  </h1>
                  <p>
                    In this short guide I’ll go over how I implemented full disk
                    encryption using LUKS on my Raspberry Pi’s root file system
                    <strong>without needing a second Linux computer</strong> to
                    run commands on. All you need is your Raspberry Pi running
                    Raspbian and a USB flash drive.
                  </p>
                  <p>An overview of the process:</p>
                  <ol class="arabic simple">
                    <li>
                      <p>
                        Install software on your Raspberry Pi’s Raspbian OS.
                      </p>
                    </li>
                    <li>
                      <p>
                        Build a custom and boot into the
                        <a
                          class="reference external"
                          href="https://pi-ltsp.net/advanced/kernels.html#initramfs"
                          >initramfs</a
                        >.
                      </p>
                    </li>
                    <li><p>Shrink your main file system.</p></li>
                    <li>
                      <p>
                        Back up your main file system from the SD card to the
                        USB drive.
                      </p>
                    </li>
                    <li>
                      <p>
                        Wipe SD card and create an empty encrypted partition.
                      </p>
                    </li>
                    <li>
                      <p>
                        Copy back your backed-up file system from USB on to your
                        encrypted SD card.
                      </p>
                    </li>
                  </ol>
                  <div class="admonition warning">
                    <p class="admonition-title">Warning</p>
                    <p>
                      This guide involves backing up your data to a USB drive
                      and destroying all data on your SD card. Though slim there
                      is a possibility of failure. Be sure to have
                      <strong>proper backups of your Raspberry Pi</strong> in
                      case something goes wrong. Also note that
                      <strong
                        >all data on your USB drive will be destroyed</strong
                      >
                      during the process since it will temporarily hold all of
                      your Raspberry Pi’s data.
                    </p>
                  </div>
                  <p>
                    At the time of this writing I’ve tested this guide against
                    <em>2017-01-11-raspbian-jessie.zip</em> and
                    <em>2017-01-11-raspbian-jessie-lite.zip</em> on a
                    <em>Raspberry Pi 3 Model B V1.2</em> and a
                    <em>Raspberry Pi Zero V1.3</em>.
                  </p>
                  <div class="section" id="install-software">
                    <h2>
                      Install Software<a
                        class="headerlink"
                        href="#install-software"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      We’ll begin by installing software and creating a new
                      initramfs for your Raspberry Pi. This new initramfs will
                      have the
                      <code class="docutils literal notranslate"
                        ><span class="pre">cryptsetup</span></code
                      >
                      program needed to unlock the encrypted partition on every
                      boot. We’ll also include other tools to assist in the
                      initial encryption of your existing data.
                    </p>
                    <p>First install some software:</p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>sudo apt-get install busybox cryptsetup initramfs-tools
</pre>
                      </div>
                    </div>
                    <p>
                      Next we’ll need to add a kernel post-install script. Since
                      Raspbian doesn’t normally use an initrd/initramfs it
                      doesn’t auto-update the one we’re about to create when a
                      new kernel version comes out. Our initramfs holds kernel
                      modules since they’re needed before the encrypted root
                      file system can be mounted. When the kernel version
                      changes it won’t be able to find its new modules. To fix
                      this write the following to
                      <code class="docutils literal notranslate"
                        ><span class="pre"
                          >/etc/kernel/postinst.d/initramfs-rebuild</span
                        ></code
                      >:
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="ch">#!/bin/sh -e</span>

<span class="c1"># Rebuild initramfs.gz after kernel upgrade to include new kernel&#39;s modules.</span>
<span class="c1"># https://github.com/Robpol86/robpol86.com/blob/master/docs/_static/initramfs-rebuild.sh</span>
<span class="c1"># Save as (chmod +x): /etc/kernel/postinst.d/initramfs-rebuild</span>

<span class="c1"># Remove splash from cmdline.</span>
<span class="k">if</span> grep -q <span class="s1">&#39;\bsplash\b&#39;</span> /boot/cmdline.txt<span class="p">;</span> <span class="k">then</span>
  sed -i <span class="s1">&#39;s/ \?splash \?/ /&#39;</span> /boot/cmdline.txt
<span class="k">fi</span>

<span class="c1"># Exit if not building kernel for this Raspberry Pi&#39;s hardware version.</span>
<span class="nv">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">current_version</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>uname -r<span class="k">)</span><span class="s2">&quot;</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">current_version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">in</span>
  *-v7+<span class="o">)</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">in</span>
      *-v7+<span class="o">)</span> <span class="p">;;</span>
      *<span class="o">)</span> <span class="nb">exit</span> <span class="m">0</span>
    <span class="k">esac</span>
  <span class="p">;;</span>
  *+<span class="o">)</span>
    <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">in</span>
      *-v7+<span class="o">)</span> <span class="nb">exit</span> <span class="m">0</span> <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="p">;;</span>
<span class="k">esac</span>

<span class="c1"># Exit if rebuild cannot be performed or not needed.</span>
<span class="o">[</span> -x /usr/sbin/mkinitramfs <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="o">[</span> -f /boot/initramfs.gz <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
lsinitramfs /boot/initramfs.gz <span class="p">|</span>grep -q <span class="s2">&quot;/</span><span class="nv">$version</span>$<span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>  <span class="c1"># Already in initramfs.</span>

<span class="c1"># Rebuild.</span>
mkinitramfs -o /boot/initramfs.gz <span class="s2">&quot;</span><span class="nv">$version</span><span class="s2">&quot;</span>
</pre>
                      </div>
                    </div>
                    <p>
                      Now we want
                      <code class="docutils literal notranslate"
                        ><span class="pre">resize2fs</span></code
                      >
                      and
                      <code class="docutils literal notranslate"
                        ><span class="pre">fdisk</span></code
                      >
                      to be included in our initramfs so we’ll need to create a
                      hook file. Write the following to
                      <code class="docutils literal notranslate"
                        ><span class="pre"
                          >/etc/initramfs-tools/hooks/resize2fs</span
                        ></code
                      >:
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="ch">#!/bin/sh -e</span>

<span class="c1"># Copy resize2fs, fdisk, and other kernel modules into initramfs image.</span>
<span class="c1"># https://github.com/Robpol86/robpol86.com/blob/master/docs/_static/resize2fs.sh</span>
<span class="c1"># Save as (chmod +x): /etc/initramfs-tools/hooks/resize2fs</span>

<span class="nv">COMPATIBILITY</span><span class="o">=</span><span class="nb">true</span>  <span class="c1"># Set to false to skip copying other kernel&#39;s modules.</span>

<span class="nv">PREREQ</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
prereqs <span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">PREREQ</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="o">}</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">in</span>
  prereqs<span class="o">)</span>
    prereqs
    <span class="nb">exit</span> <span class="m">0</span>
  <span class="p">;;</span>
<span class="k">esac</span>

. /usr/share/initramfs-tools/hook-functions

copy_exec /sbin/resize2fs /sbin
copy_exec /sbin/fdisk /sbin

<span class="c1"># Raspberry Pi 1 and 2+3 use different kernels. Include the other.</span>
<span class="k">if</span> <span class="si">${</span><span class="nv">COMPATIBILITY</span><span class="si">}</span><span class="p">;</span> <span class="k">then</span>
  <span class="k">case</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">version</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">in</span>
    *-v7+<span class="o">)</span> <span class="nv">other_version</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span> <span class="p">|</span>sed <span class="s1">&#39;s/-v7+$/+/&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="p">;;</span>
    *+<span class="o">)</span> <span class="nv">other_version</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">version</span><span class="si">}</span> <span class="p">|</span>sed <span class="s1">&#39;s/+$/-v7+/&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="p">;;</span>
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&quot;Warning: kernel version doesn&#39;t end with +, ignoring.&quot;</span>
      <span class="nb">exit</span> <span class="m">0</span>
  <span class="k">esac</span>
  cp -r /lib/modules/<span class="si">${</span><span class="nv">other_version</span><span class="si">}</span> <span class="si">${</span><span class="nv">DESTDIR</span><span class="si">}</span>/lib/modules/
<span class="k">fi</span>
</pre>
                      </div>
                    </div>
                    <div class="admonition note">
                      <p class="admonition-title">Note</p>
                      <p>
                        Raspbian ships with two Linux kernels: one for the
                        Raspberry Pi 1 (including Pi Zero), and another for the
                        Raspberry Pi 2 and 3. In order to keep the ability of
                        using one SD card on all Raspberry Pis the above script
                        will include the other kernel’s modules (the current
                        kernel’s modules are the only ones included by default).
                        This will double the size of the
                        <code class="docutils literal notranslate"
                          ><span class="pre">initramfs.gz</span></code
                        >
                        file. If you don’t plan on using this SD card on a
                        different Raspberry Pi you can set
                        <code class="docutils literal notranslate"
                          ><span class="pre">COMPATIBILITY</span></code
                        >
                        to
                        <code class="docutils literal notranslate"
                          ><span class="pre">false</span></code
                        >
                        and re-run
                        <code class="docutils literal notranslate"
                          ><span class="pre">mkinitramfs</span></code
                        >
                        below.
                      </p>
                    </div>
                    <p>
                      Finally let’s build the new initramfs and make sure our
                      utilities have been installed. The
                      <code class="docutils literal notranslate"
                        ><span class="pre">mkinitramfs</span></code
                      >
                      command may print some WARNINGs from cryptsetup, but that
                      should be fine since we’re using
                      <code class="docutils literal notranslate"
                        ><span class="pre">CRYPTSETUP=y</span></code
                      >. As long as cryptsetup itself is present in the
                      initramfs it won’t be a problem.
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>sudo chmod +x /etc/kernel/postinst.d/initramfs-rebuild
sudo chmod +x /etc/initramfs-tools/hooks/resize2fs
sudo -E <span class="nv">CRYPTSETUP</span><span class="o">=</span>y mkinitramfs -o /boot/initramfs.gz
lsinitramfs /boot/initramfs.gz <span class="p">|</span>grep -P <span class="s2">&quot;sbin/(cryptsetup|resize2fs|fdisk)&quot;</span>
</pre>
                      </div>
                    </div>
                    <p>
                      Make sure you see
                      <code class="docutils literal notranslate"
                        ><span class="pre">sbin/resize2fs</span></code
                      >,
                      <code class="docutils literal notranslate"
                        ><span class="pre">sbin/cryptsetup</span></code
                      >, and
                      <code class="docutils literal notranslate"
                        ><span class="pre">sbin/fdisk</span></code
                      >
                      in the output.
                    </p>
                  </div>
                  <div class="section" id="prepare-boot-files">
                    <h2>
                      Prepare Boot Files<a
                        class="headerlink"
                        href="#prepare-boot-files"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      Next step is to make some changes to some configuration
                      files telling the Raspberry Pi to boot our
                      soon-to-be-created encrypted partition. We’ll make these
                      changes first since they’re relatively easily reversible
                      if you mount your SD card on another computer, should you
                      wish to abort this process. Edit these files with these
                      changes:
                    </p>
                    <dl class="describe">
                      <dt class="sig sig-object">
                        <span class="sig-name descname"
                          ><span class="pre">/boot/config.txt</span></span
                        >
                      </dt>
                      <dd>
                        <p>
                          Append
                          <code class="docutils literal notranslate"
                            ><span class="pre">initramfs</span>
                            <span class="pre">initramfs.gz</span>
                            <span class="pre">followkernel</span></code
                          >
                          to the end of the file.
                        </p>
                      </dd>
                    </dl>

                    <dl class="describe">
                      <dt class="sig sig-object">
                        <span class="sig-name descname"
                          ><span class="pre">/boot/cmdline.txt</span></span
                        >
                      </dt>
                      <dd>
                        <ol class="arabic simple">
                          <li>
                            <p>
                              Append
                              <code class="docutils literal notranslate"
                                ><span class="pre"
                                  >cryptdevice=/dev/mmcblk0p2:sdcard</span
                                ></code
                              >
                              to the end of the line.
                            </p>
                          </li>
                          <li>
                            <p>
                              Replace
                              <code class="docutils literal notranslate"
                                ><span class="pre"
                                  >root=/dev/mmcblk0p2</span
                                ></code
                              >
                              with
                              <code class="docutils literal notranslate"
                                ><span class="pre"
                                  >root=/dev/mapper/sdcard</span
                                ></code
                              >
                            </p>
                          </li>
                        </ol>
                      </dd>
                    </dl>

                    <dl class="describe">
                      <dt class="sig sig-object">
                        <span class="sig-name descname"
                          ><span class="pre">/etc/fstab</span></span
                        >
                      </dt>
                      <dd>
                        <p>
                          Replace
                          <code class="docutils literal notranslate"
                            ><span class="pre">/dev/mmcblk0p2</span></code
                          >
                          with
                          <code class="docutils literal notranslate"
                            ><span class="pre">/dev/mapper/sdcard</span></code
                          >
                        </p>
                      </dd>
                    </dl>

                    <dl class="describe">
                      <dt class="sig sig-object">
                        <span class="sig-name descname"
                          ><span class="pre">/etc/crypttab</span></span
                        >
                      </dt>
                      <dd>
                        <p>
                          Append
                          <code class="docutils literal notranslate"
                            ><span class="pre">sdcard</span>&#160;
                            <span class="pre">/dev/mmcblk0p2</span>&#160;
                            <span class="pre">none</span>&#160;&#160;&#160;
                            <span class="pre">luks</span></code
                          >
                          to the end of the file.
                        </p>
                      </dd>
                    </dl>

                    <p>
                      Now run
                      <code class="docutils literal notranslate"
                        ><span class="pre">sudo</span>
                        <span class="pre">reboot</span></code
                      >. The Raspberry Pi will fail to boot and drop you into
                      the initramfs shell.
                    </p>
                  </div>
                  <div class="section" id="shrink-and-encrypt">
                    <h2>
                      Shrink and Encrypt<a
                        class="headerlink"
                        href="#shrink-and-encrypt"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      To speed up this process we’ll be shrinking the file
                      system since all of this will be done on the Raspberry Pi.
                      Long running commands should take around 9 minutes each on
                      a Raspberry Pi 3 with a clean Raspbian PIXEL OS and a fast
                      SD card.
                    </p>
                    <div class="admonition note">
                      <p class="admonition-title">Note</p>
                      <p>
                        When running
                        <code class="docutils literal notranslate"
                          ><span class="pre">resize2fs</span></code
                        >
                        it will print out the new size of the file system. Keep
                        track of the number of 4k blocks it tells you since you
                        need to give that number to
                        <code class="docutils literal notranslate"
                          ><span class="pre">dd</span></code
                        >. For reference my resize2fs said:
                      </p>
                      <div class="highlight-text notranslate">
                        <div class="highlight">
                          <pre><span></span>The file system on /dev/mmcblk0p2 is now 1397823 (4k) blocks long.
</pre>
                        </div>
                      </div>
                      <p>So “1397823” is my number of interest.</p>
                    </div>
                    <p>
                      First we’ll shrink and copy to the USB drive.
                      <strong>Insert your USB drive</strong> and run these
                      commands.
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>e2fsck -f /dev/mmcblk0p2  <span class="c1"># Check SD card for errors for safety.</span>
resize2fs -fM /dev/mmcblk0p2  <span class="c1"># Shrink the file system on the SD card.</span>
<span class="c1"># Write down the number of 4k blocks long in the resize2fs output.</span>
<span class="c1"># Substitute &quot;1397823&quot; below with your number of interest.</span>
dd <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span><span class="m">1397823</span> <span class="k">if</span><span class="o">=</span>/dev/mmcblk0p2 <span class="p">|</span>sha1sum <span class="c1"># Write down the SHA1.</span>
fdisk -l /dev/sda  <span class="c1"># Make sure /dev/sda is your USB drive. If not check dmesg.</span>
dd <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span><span class="m">1397823</span> <span class="k">if</span><span class="o">=</span>/dev/mmcblk0p2 <span class="nv">of</span><span class="o">=</span>/dev/sda  <span class="c1"># Copy data to USB drive.</span>
dd <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span><span class="m">1397823</span> <span class="k">if</span><span class="o">=</span>/dev/sda <span class="p">|</span>sha1sum <span class="c1"># Make sure it&#39;s the same value!</span>
</pre>
                      </div>
                    </div>
                    <p>
                      Now it’s time to wipe your SD card’s main partition and
                      create an empty encrypted one in its place. The first
                      <code class="docutils literal notranslate"
                        ><span class="pre">cryptsetup</span></code
                      >
                      command will prompt you for the password you want to use
                      for your encrypted partition. Make sure it’s a strong one.
                    </p>
                    <div class="admonition note">
                      <p class="admonition-title">Note</p>
                      <p>
                        While copying data back to the SD card I got a bunch of
                        these messages:
                      </p>
                      <div class="highlight-text notranslate">
                        <div class="highlight">
                          <pre><span></span>[ 2280.148837] INFO: task kworker/u8:5:357 blocked for more than 120 seconds.
                     Not tainted 4.4.38-v7+ #938
</pre>
                        </div>
                      </div>
                      <p>
                        I ignored these since the
                        <code class="docutils literal notranslate"
                          ><span class="pre">sha1sum</span></code
                        >
                        command I ran afterward assured me the data was copied
                        over correctly.
                      </p>
                    </div>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>cryptsetup --cipher aes-cbc-essiv:sha256 luksFormat /dev/mmcblk0p2
cryptsetup luksOpen /dev/mmcblk0p2 sdcard  <span class="c1"># Mounts the encrypted file system.</span>
dd <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span><span class="m">1397823</span> <span class="k">if</span><span class="o">=</span>/dev/sda <span class="nv">of</span><span class="o">=</span>/dev/mapper/sdcard <span class="c1"># Copy back your data.</span>
dd <span class="nv">bs</span><span class="o">=</span>4k <span class="nv">count</span><span class="o">=</span><span class="m">1397823</span> <span class="k">if</span><span class="o">=</span>/dev/mapper/sdcard <span class="p">|</span>sha1sum <span class="c1"># Make sure it&#39;s the same!</span>
e2fsck -f /dev/mapper/sdcard  <span class="c1"># Check encrypted SD card for errors.</span>
resize2fs -f /dev/mapper/sdcard  <span class="c1"># Expand back to full size.</span>
<span class="c1"># Remove USB drive, no longer needed.</span>
<span class="nb">exit</span>  <span class="c1"># Continue to boot into your encrypted SD card.</span>
</pre>
                      </div>
                    </div>
                    <p>
                      Your Raspberry Pi should successfully boot into your
                      desktop or command line (depending if you use Raspbian
                      Lite or PIXEL). Test everything out by rebooting. You’ll
                      need to run
                      <code class="docutils literal notranslate"
                        ><span class="pre">cryptsetup</span>
                        <span class="pre">luksOpen</span>
                        <span class="pre">/dev/mmcblk0p2</span>
                        <span class="pre">sdcard</span></code
                      >
                      on every boot from now on.
                    </p>
                  </div>
                  <div class="section" id="pretty-password-prompt">
                    <h2>
                      Pretty Password Prompt<a
                        class="headerlink"
                        href="#pretty-password-prompt"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      Everything should work fine now, except for the fact that
                      every time the Raspberry Pi boots it drops you into the
                      initramfs shell and you need to remember to type in the
                      luksOpen command since there is no bash history. It would
                      be nice to just have to enter your password.
                    </p>
                    <p>
                      It’s actually really easy! The only drawback is that
                      you’ll need to disable the pretty PIXEL splash screen (if
                      you’re not using the Raspbian Lite image) in order to see
                      the prompt. If you’re on the PIXEL image go ahead and
                      disable the splash screen:
                    </p>
                    <dl class="describe">
                      <dt class="sig sig-object">
                        <span class="sig-name descname"
                          ><span class="pre">/boot/cmdline.txt</span></span
                        >
                      </dt>
                      <dd>
                        <p>
                          If you’re on the PIXEL image edit this file and remove
                          <code class="docutils literal notranslate"
                            ><span class="pre">splash</span></code
                          >
                          from the line.
                        </p>
                      </dd>
                    </dl>

                    <p>
                      Now build a new initramfs. This time there should be no
                      WARNINGs at all. Again make sure our three programs are
                      present in our new initramfs:
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>sudo mkinitramfs -o /tmp/initramfs.gz
lsinitramfs /tmp/initramfs.gz <span class="p">|</span>grep -P <span class="s2">&quot;sbin/(cryptsetup|resize2fs|fdisk)&quot;</span>
sudo cp /tmp/initramfs.gz /boot/initramfs.gz
sudo reboot
</pre>
                      </div>
                    </div>
                    <p>
                      And that’s it. It should prompt you with something like
                      “Please unlock disk /dev/mmcblk0p2 (sdcard)”. If you’re
                      running Raspbian Lite the password prompt may be lost with
                      other start-up messages. Just press the Enter key once it
                      calms down and you should see the prompt again.
                    </p>
                  </div>
                  <div class="section" id="references">
                    <h2>
                      References<a
                        class="headerlink"
                        href="#references"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <ul class="simple">
                      <li>
                        <p>
                          <a
                            class="reference external"
                            href="http://paxswill.com/blog/2013/11/04/encrypted-raspberry-pi/"
                            >http://paxswill.com/blog/2013/11/04/encrypted-raspberry-pi/</a
                          >
                        </p>
                      </li>
                      <li>
                        <p>
                          <a
                            class="reference external"
                            href="https://github.com/NicoHood/NicoHood.github.io/wiki/Raspberry-Pi-Encrypt-Root-Partition-Tutorial"
                            >https://github.com/NicoHood/NicoHood.github.io/wiki/Raspberry-Pi-Encrypt-Root-Partition-Tutorial</a
                          >
                        </p>
                      </li>
                    </ul>
                  </div>
                  <div class="section" id="comments">
                    <h2>
                      Comments<a
                        class="headerlink"
                        href="#comments"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <div
                      data-disqus-identifier="Raspberry Pi LUKS Root Encryption"
                      data-disqus-shortname="rob86wiki"
                      id="disqus_thread"
                    ></div>
                  </div>
                </div>
              </div>

              <!-- Previous / next buttons -->
              <div class="prev-next-area">
                <a
                  class="left-prev"
                  id="prev-link"
                  href="windows_11_mac.html"
                  title="previous page"
                >
                  <i class="fas fa-angle-left"></i>
                  <div class="prev-next-info">
                    <p class="prev-next-subtitle">previous</p>
                    <p class="prev-next-title">
                      Installing Windows 11 on a Mac
                    </p>
                  </div>
                </a>
                <a
                  class="right-next"
                  id="next-link"
                  href="root_certificate_authority.html"
                  title="next page"
                >
                  <div class="prev-next-info">
                    <p class="prev-next-subtitle">next</p>
                    <p class="prev-next-title">Setting Up a Home Root CA</p>
                  </div>
                  <i class="fas fa-angle-right"></i>
                </a>
              </div>
            </div>
          </div>
          <footer class="footer">
            <p>
              &copy; Copyright 2022, Robpol86.<br />
              Last updated on Jan 23, 2022, 1:28:06 AM UTC.<br />
            </p>
          </footer>
        </main>
      </div>
    </div>

    <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
  </body>
</html>
