<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      property="article:modified_time"
      content="2022-01-23T01:28:06+00:00"
    />
    <meta property="og:title" content="Bareos Tape Backup on a 124T" />

    <meta property="og:type" content="website" />

    <meta
      property="og:url"
      content="https://rob86stage.robpol86.com/bareos_tape_backup.html"
    />

    <meta property="og:site_name" content="Robpol86.com" />

    <meta
      property="og:description"
      content="I use Bareos(a fork of Bacula) to backup my data at home from a Linux computer to tape. Backing up to tape is a lot more convenient that backing up to DVD-R/BD-R, though it’s probably debatable when compared to backing up to an external hard drive. But having a tape autoloader is so cool! Equipme..."
    />

    <meta property="og:image" content="https://i.imgur.com/7DZQth.jpg" />

    <meta property="og:image:alt" content="Robpol86.com" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="twitter:domain" content="rob86stage.robpol86.com" />
    <title>Bareos Tape Backup on a 124T &#8212; Robpol86.com</title>

    <link href="_static/css/theme.css" rel="stylesheet" />
    <link
      href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="_static/vendor/fontawesome/5.13.0/css/all.min.css"
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin
      href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2"
    />
    <link
      rel="preload"
      as="font"
      type="font/woff2"
      crossorigin
      href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2"
    />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/sphinx-book-theme.css?digest=84ace793992934648b4de8eed757e5a2"
    />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="_static/background_image.css"
    />
    <link rel="stylesheet" type="text/css" href="_static/fixes.css" />

    <link
      rel="preload"
      as="script"
      href="_static/js/index.be7d3bbb2ef33a8344ce.js"
    />

    <script
      data-url_root="./"
      id="documentation_options"
      src="_static/documentation_options.js"
    ></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/sphinx-book-theme.9d8b4a8b9bb19db25eeaddc40d639ba2.js"></script>
    <script src="_static/disqus.js"></script>
    <link
      rel="canonical"
      href="https://rob86stage.robpol86.com/bareos_tape_backup.html"
    />

    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link
      rel="next"
      title="Flashing Motorola Droid to Cricket"
      href="flash_droid_cricket.html"
    />
    <link
      rel="prev"
      title="Postfix and Gmail Forwarding"
      href="postfix_gmail_forwarding.html"
    />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/apple-touch-icon.png?v=210604"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon-32x32.png?v=210604"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon-16x16.png?v=210604"
    />
    <link rel="manifest" href="/site.webmanifest?v=210604" />
    <link
      rel="mask-icon"
      href="/safari-pinned-tab.svg?v=210604"
      color="#7c7c7c"
    />
    <link rel="shortcut icon" href="/favicon.ico?v=210604" />
    <meta name="apple-mobile-web-app-title" content="Robpol86.com" />
    <meta name="application-name" content="Robpol86.com" />
    <meta name="msapplication-TileColor" content="#00a300" />
    <meta name="theme-color" content="#ffffff" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />

    <!-- Google Analytics -->
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    <div class="container-fluid" id="banner"></div>

    <div class="container-xl">
      <div class="row">
        <!-- Checkboxes to toggle the left sidebar -->
        <input
          type="checkbox"
          class="sidebar-toggle"
          name="__navigation"
          id="__navigation"
          aria-label="Toggle navigation sidebar"
        />
        <label class="overlay" for="__navigation">
          <div class="visually-hidden">Toggle navigation sidebar</div>
        </label>
        <div
          class="col-12 col-md-3 bd-sidebar site-navigation"
          id="site-navigation"
        >
          <div class="navbar-brand-box">
            <a class="navbar-brand text-wrap" href="index.html">
              <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->

              <img src="_static/logo.svg" class="logo" alt="logo" />
            </a>
          </div>
          <form
            class="bd-search d-flex align-items-center"
            action="search.html"
            method="get"
          >
            <i class="icon fas fa-search"></i>
            <input
              type="search"
              class="form-control"
              name="q"
              id="search-input"
              placeholder="Search the docs ..."
              aria-label="Search the docs ..."
              autocomplete="off"
            />
          </form>
          <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
            <div class="bd-toc-item active">
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Projects </span>
              </p>
              <ul class="nav bd-sidenav">
                <li class="toctree-l1">
                  <a class="reference internal" href="vw_alltrack_2019.html">
                    Golf Alltrack SE
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="mib2_comp_media.html">
                    MIB2 Composition Media Hacking
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="3d_printer_mpms2.html">
                    Monoprice Maker Select v2
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="franklin_t9.html">
                    T-Mobile Franklin T9 Hacking
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="photo_albums.html">
                    Photo Albums
                  </a>
                </li>
              </ul>
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Tutorials </span>
              </p>
              <ul class="current nav bd-sidenav">
                <li class="toctree-l1">
                  <a class="reference internal" href="windows_11_mac.html">
                    Installing Windows 11 on a Mac
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="raspberry_pi_luks.html">
                    Raspberry Pi LUKS Root Encryption
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="root_certificate_authority.html"
                  >
                    Setting Up a Home Root CA
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="raspberry_pi_project_fi.html"
                  >
                    Raspberry Pi on Project Fi
                  </a>
                </li>
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="postfix_gmail_forwarding.html"
                  >
                    Postfix and Gmail Forwarding
                  </a>
                </li>
                <li class="toctree-l1 current active">
                  <a class="current reference internal" href="#">
                    Bareos Tape Backup on a 124T
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="flash_droid_cricket.html">
                    Flashing Motorola Droid to Cricket
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="rns_510_vim.html">
                    US RNS-510 Video In Motion
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="imagecfg.html">
                    ImageCFG
                  </a>
                </li>
              </ul>
              <p aria-level="2" class="caption" role="heading">
                <span class="caption-text"> Archived Projects </span>
              </p>
              <ul class="nav bd-sidenav">
                <li class="toctree-l1">
                  <a
                    class="reference internal"
                    href="wireless_charging_car_dock.html"
                  >
                    Wireless Charging Car Dock
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="atrix_lapdock.html">
                    Atrix Lapdock Other Uses
                  </a>
                </li>
                <li class="toctree-l1">
                  <a class="reference internal" href="vw_jsw_2010.html">
                    Jetta SportWagen TDI
                  </a>
                </li>
              </ul>
            </div>
          </nav>
          <!-- To handle the deprecated key -->

          <div class="navbar_extra_footer">
            <p>
              <a href="/genindex.html">Tags</a> |
              <a href="/sitemap.xml">Sitemap</a><br />Generator:
              <a href="https://www.sphinx-doc.org/">Sphinx</a><br />Theme:
              <a href="https://sphinx-book-theme.readthedocs.io/"
                >Sphinx Book Theme</a
              ><br />Host:
              <a href="https://www.nearlyfreespeech.net/"
                >NearlyFreeSpeech.NET</a
              ><br />License:
              <a
                href="https://github.com/Robpol86/robpol86.com/blob/main/LICENSE"
                >BSD-2-Clause</a
              ><br />
            </p>
          </div>
        </div>

        <!-- This is an invisible pixel that we watch to see if we've scrolled. -->
        <div class="sbt-scroll-pixel-helper"></div>
        <main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
          <div class="topbar container-xl fixed-top">
            <div class="topbar-contents row">
              <div
                class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"
              ></div>
              <div class="col pl-md-4 topbar-main">
                <div class="topbar-left">
                  <label class="nav-toggle-button" for="__navigation">
                    <div class="visually-hidden">Toggle navigation</div>
                    <i class="fas fa-bars"></i>
                  </label>
                </div>

                <div class="dropdown-buttons-trigger">
                  <button
                    id="dropdown-buttons-trigger"
                    class="btn btn-secondary topbarbtn"
                    aria-label="Download this page"
                  >
                    <i class="fas fa-download"></i>
                  </button>

                  <div class="dropdown-buttons">
                    <!-- ipynb file if we had a myst markdown file -->

                    <!-- Download raw file -->
                    <a class="dropdown-buttons" href="_sources/"
                      ><button
                        type="button"
                        class="btn btn-secondary topbarbtn"
                        title="Download source file"
                        data-toggle="tooltip"
                        data-placement="left"
                      >
                        .rst
                      </button></a
                    >
                    <!-- Download PDF via print -->
                    <button
                      type="button"
                      id="download-print"
                      class="btn btn-secondary topbarbtn"
                      title="Print to PDF"
                      onclick="printPdf(this)"
                      data-toggle="tooltip"
                      data-placement="left"
                    >
                      .pdf
                    </button>
                  </div>
                </div>

                <!-- GitHub link -->

                <a
                  class="edit-button"
                  href="https://github.com/Robpol86/robpol86.com/blob/main/docs/bareos_tape_backup.rst"
                >
                  <button
                    type="button"
                    class="btn btn-secondary topbarbtn"
                    data-toggle="tooltip"
                    data-placement="bottom"
                    aria-label="Edit this page"
                    title="Edit this page"
                  >
                    <i class="fab fa-github"></i>
                  </button>
                </a>

                <!-- Full screen (wrap in <a> to have style consistency -->

                <a class="full-screen-button"
                  ><button
                    type="button"
                    class="btn btn-secondary topbarbtn"
                    data-toggle="tooltip"
                    data-placement="bottom"
                    onclick="toggleFullScreen()"
                    aria-label="Fullscreen mode"
                    title="Fullscreen mode"
                  >
                    <i class="fas fa-expand"></i></button
                ></a>

                <!-- Launch buttons -->
              </div>

              <!-- Table of contents -->
              <div class="d-none d-md-block col-md-2 bd-toc show noprint">
                <div class="tocsection onthispage pt-5 pb-3">
                  <i class="fas fa-list"></i> Contents
                </div>
                <nav id="bd-toc-nav" aria-label="Page">
                  <ul class="visible nav section-nav flex-column">
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#equipment-used"
                      >
                        Equipment Used
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#installation"
                      >
                        Installation
                      </a>
                      <ul class="nav section-nav flex-column">
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#verify-tape-drive-autoloader"
                          >
                            Verify Tape Drive/Autoloader
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#install-bareos"
                          >
                            Install Bareos
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#file-storage-daemon-config"
                          >
                            File/Storage Daemon Config
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#verify-storage-config"
                          >
                            Verify Storage Config
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#director-daemon-config"
                          >
                            Director Daemon Config
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#start-services"
                          >
                            Start Services
                          </a>
                        </li>
                        <li class="toc-h3 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#test-everything"
                          >
                            Test Everything
                          </a>
                        </li>
                      </ul>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#reusing-old-tapes"
                      >
                        Reusing Old Tapes
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a
                        class="reference internal nav-link"
                        href="#backing-up-data"
                      >
                        Backing Up Data
                      </a>
                    </li>
                    <li class="toc-h2 nav-item toc-entry">
                      <a class="reference internal nav-link" href="#comments">
                        Comments
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>
          <div id="main-content" class="row">
            <div class="col-12 col-md-9 pl-md-3 pr-md-0">
              <!-- Table of contents that is only displayed when printing the page -->
              <div id="jb-print-docs-body" class="onlyprint">
                <h1>Bareos Tape Backup on a 124T</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                  <div id="jb-print-toc">
                    <div>
                      <h2>Contents</h2>
                    </div>
                    <nav aria-label="Page">
                      <ul class="visible nav section-nav flex-column">
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#equipment-used"
                          >
                            Equipment Used
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#installation"
                          >
                            Installation
                          </a>
                          <ul class="nav section-nav flex-column">
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#verify-tape-drive-autoloader"
                              >
                                Verify Tape Drive/Autoloader
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#install-bareos"
                              >
                                Install Bareos
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#file-storage-daemon-config"
                              >
                                File/Storage Daemon Config
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#verify-storage-config"
                              >
                                Verify Storage Config
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#director-daemon-config"
                              >
                                Director Daemon Config
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#start-services"
                              >
                                Start Services
                              </a>
                            </li>
                            <li class="toc-h3 nav-item toc-entry">
                              <a
                                class="reference internal nav-link"
                                href="#test-everything"
                              >
                                Test Everything
                              </a>
                            </li>
                          </ul>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#reusing-old-tapes"
                          >
                            Reusing Old Tapes
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#backing-up-data"
                          >
                            Backing Up Data
                          </a>
                        </li>
                        <li class="toc-h2 nav-item toc-entry">
                          <a
                            class="reference internal nav-link"
                            href="#comments"
                          >
                            Comments
                          </a>
                        </li>
                      </ul>
                    </nav>
                  </div>
                </div>
              </div>

              <div>
                <div class="section" id="bareos-tape-backup-on-a-124t">
                  <span id="bareos-tape-backup"></span>
                  <h1>
                    Bareos Tape Backup on a 124T<a
                      class="headerlink"
                      href="#bareos-tape-backup-on-a-124t"
                      title="Permalink to this headline"
                      >¶</a
                    >
                  </h1>
                  <p>
                    I use
                    <a
                      class="reference external"
                      href="https://www.bareos.org/en/"
                      >Bareos</a
                    >
                    (a fork of
                    <a class="reference external" href="http://bacula.org/"
                      >Bacula</a
                    >) to backup my data at home from a Linux computer to tape.
                    Backing up to tape is a lot more convenient that backing up
                    to DVD-R/BD-R, though it’s probably debatable when compared
                    to backing up to an external hard drive. But having a tape
                    autoloader is so cool!
                  </p>
                  <blockquote
                    class="imgur-embed-pub"
                    data-context="false"
                    data-id="7DZQt"
                    lang="en"
                  >
                    <a class="reference external" href="https://imgur.com/7DZQt"
                      >Loading...</a
                    >
                  </blockquote>
                  <script
                    async=""
                    charset="utf-8"
                    src="//s.imgur.com/min/embed.js"
                  ></script>
                  <div class="section" id="equipment-used">
                    <h2>
                      Equipment Used<a
                        class="headerlink"
                        href="#equipment-used"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      This guide should work with other pieces of equipment but
                      it has been written with these devices in mind:
                    </p>
                    <ul class="simple">
                      <li><p>CentOS 7.1</p></li>
                      <li>
                        <p>
                          <a
                            class="reference external"
                            href="http://www.dell.com/us/business/p/powervault-124t-lto4hh/pd"
                            >Dell PowerVault 124T Tape Autoloader</a
                          >
                        </p>
                      </li>
                      <li>
                        <p>
                          <a
                            class="reference external"
                            href="http://www-01.ibm.com/support/docview.wss?uid=swg21193425"
                            >IBM Ultrium-TD3 Tape Drive</a
                          >
                          (inside the autoloader).
                        </p>
                      </li>
                    </ul>
                    <p>
                      The plan is to rsync data from my OS X client to a
                      directory on my Linux server, and to run all Bareos
                      software on just the server. I didn’t like the idea of
                      having some process running as root on OS X and trust that
                      it only accessed a specific volume, which isn’t even
                      configured on OS X (it’s set in the Bareos director config
                      on the Linux server).
                    </p>
                    <p>
                      I’ll be running backups manually. I won’t have any running
                      schedules in Bareos and I’ll have MariaDB (MySQL on
                      CentOS) and Bareos not start on boot. After every backup
                      I’ll stop those services.
                    </p>
                    <p>
                      I’ll also only be defining full backups. I won’t be
                      defining any differential/incremental jobs in this guide.
                    </p>
                  </div>
                  <div class="section" id="installation">
                    <h2>
                      Installation<a
                        class="headerlink"
                        href="#installation"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      We’ll be installing Bareos and its dependencies from
                      scratch on a new CentOS install. Some things I’d like to
                      point out:
                    </p>
                    <ol class="arabic simple">
                      <li>
                        <p>
                          The giant
                          <code class="docutils literal notranslate"
                            ><span class="pre">bareos-dir.conf</span></code
                          >
                          will be split up into 3 files for easier
                          manageability.
                        </p>
                      </li>
                      <li>
                        <p>
                          I won’t be using any kind of monitoring, emailing, or
                          any sort of notifications. I’ll just manually check
                          the progress through the
                          <code class="docutils literal notranslate"
                            ><span class="pre">bconsole</span></code
                          >. Since my CentOS server doesn’t run a GUI I don’t
                          have a tray-monitor.
                        </p>
                      </li>
                    </ol>
                    <div class="section" id="verify-tape-drive-autoloader">
                      <h3>
                        Verify Tape Drive/Autoloader<a
                          class="headerlink"
                          href="#verify-tape-drive-autoloader"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        First we need to make sure the tape drive and autoloader
                        have been detected by the OS. Do this by running
                        <code class="docutils literal notranslate"
                          ><span class="pre">lsscsi</span>
                          <span class="pre">-g</span></code
                        >
                        (don’t need to be root). You should see something like
                        this:
                      </p>
                      <div class="highlight-none notranslate">
                        <div class="highlight">
                          <pre><span></span>$ lsscsi -g
[0:0:6:0]    tape    IBM      ULTRIUM-TD3      93GM  /dev/st0   /dev/sg2
[0:0:6:1]    mediumx DELL     PV-124T          0085  /dev/sch0  /dev/sg3
</pre>
                        </div>
                      </div>
                      <p>
                        If you don’t see any
                        <code class="docutils literal notranslate"
                          ><span class="pre">sg</span></code
                        >
                        devices you can try these commands, I had to run them on
                        my CentOS installation:
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo su -c <span class="s1">&#39;echo &quot;sg&quot; &gt; /etc/modules-load.d/sg.conf&#39;</span>
sudo systemctl restart systemd-modules-load.service
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="install-bareos">
                      <h3>
                        Install Bareos<a
                          class="headerlink"
                          href="#install-bareos"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        We’ll be using MariaDB as the backend database. Install
                        it and secure it.
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo yum install mariadb-server
sudo systemctl start mariadb.service
sudo systemctl disable mariadb.service
mysql_secure_installation  <span class="c1"># Ignore find_mysql_client error.</span>
</pre>
                        </div>
                      </div>
                      <p>Next install Bareos.</p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>wget <span class="s2">&quot;http://download.bareos.org/bareos/release/latest/CentOS_7/bareos.repo&quot;</span>
sudo cp bareos.repo /etc/yum.repos.d/
sudo yum install bareos bareos-database-mysql bareos-storage-tape
sudo systemctl disable bareos-dir.service
sudo systemctl disable bareos-sd.service
sudo systemctl disable bareos-fd.service
sudo /usr/lib/bareos/scripts/create_bareos_database mysql -u root -p
sudo /usr/lib/bareos/scripts/make_bareos_tables mysql -u root -p
<span class="nv">dbpw</span><span class="o">=</span><span class="k">$(</span>openssl rand -base64 <span class="m">45</span><span class="k">)</span>
sudo <span class="nv">db_password</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$dbpw</span><span class="s2">&quot;</span> /usr/lib/bareos/scripts/grant_bareos_privileges mysql -u root -p
sudo sed -i.bak <span class="s1">&#39;s@\(dbpassword =\) &quot;&quot;@\1 &quot;&#39;</span><span class="nv">$dbpw</span><span class="s1">&#39;&quot;@g&#39;</span> /etc/bareos/bareos-dir.conf
<span class="nb">unset</span> dbpw
</pre>
                        </div>
                      </div>
                      <p>
                        I’ll be using
                        <code class="docutils literal notranslate"
                          ><span class="pre">/home/bareos</span></code
                        >
                        to rsync files to. I’ll need to grant the
                        <code class="docutils literal notranslate"
                          ><span class="pre">bareos</span></code
                        >
                        user access to this so it may backup and restore files
                        there, and I’ll also need to grant another user (e.g.
                        <code class="docutils literal notranslate"
                          ><span class="pre">support</span></code
                        >) access to login through rsync (it’s a bad idea to
                        grant login privileges to bareos).
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo mkdir -m0700 /home/bareos
sudo chown bareos:bareos /home/bareos
sudo setfacl -d -m u:bareos:rwx -m g:support:rwx /home/bareos
sudo setfacl -m u:bareos:rwx -m g:support:rwx /home/bareos
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="file-storage-daemon-config">
                      <h3>
                        File/Storage Daemon Config<a
                          class="headerlink"
                          href="#file-storage-daemon-config"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        Overwrite these two files. Make sure to substitute
                        <code class="docutils literal notranslate"
                          ><span class="pre">moops</span></code
                        >
                        with the original setting. Omit the PKI lines if you do
                        not plan on
                        <a
                          class="reference external"
                          href="http://doc.bareos.org/master/html/bareos-manual-main-reference.html#x1-30500027.2"
                          >encrypting your backup file data</a
                        >.
                      </p>
                      <div class="admonition warning">
                        <p class="admonition-title">Warning</p>
                        <p>
                          While Bareos does support encryption,
                          <code class="docutils literal notranslate"
                            ><span class="pre">bscan</span></code
                          >
                          and
                          <code class="docutils literal notranslate"
                            ><span class="pre">bextract</span></code
                          >
                          do not! This means if you ever lose your Bareos server
                          and you do not have a clear-text backup of your MySQL
                          database, you won’t be able to restore the catalog
                          from tape (even if you have your encryption keys)
                          without a lot of manual and unsupported work.
                        </p>
                      </div>
                      <div class="highlight-kconfig notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># /etc/bareos/bareos-fd.conf</span>
Director<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-dir<span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
}<span class="w"></span>

FileDaemon<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-fd<span class="w"></span>
<span class="w">  </span>Maximum<span class="w"> </span>Concurrent<span class="w"> </span>Jobs<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"></span>
<span class="w">  </span>PKI<span class="w"> </span>Signatures<span class="w"> </span><span class="o">=</span><span class="w"> </span>Yes<span class="w">  </span><span class="c1"># Enable Data Signing</span>
<span class="w">  </span>PKI<span class="w"> </span>Encryption<span class="w"> </span><span class="o">=</span><span class="w"> </span>Yes<span class="w">  </span><span class="c1"># Enable Data Encryption</span>
<span class="w">  </span>PKI<span class="w"> </span>Keypair<span class="w"> </span><span class="o">=</span><span class="w"> </span>/etc/bareos/moops-fd.pem<span class="w">  </span><span class="c1"># Public and Private Keys</span>
<span class="w">  </span>PKI<span class="w"> </span>Master<span class="w"> </span>Key<span class="w"> </span><span class="o">=</span><span class="w"> </span>/etc/bareos/master.cert<span class="w">  </span><span class="c1"># ONLY the Public Key</span>
}<span class="w"></span>

Messages<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Standard<span class="w"></span>
<span class="w">  </span>director<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-dir<span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>skipped,<span class="w"> </span><span class="o">!</span>restored<span class="w"></span>
}<span class="w"></span>
</pre>
                        </div>
                      </div>
                      <p>
                        For the storage daemon substitute
                        <code class="docutils literal notranslate"
                          ><span class="pre">/dev/sg3</span></code
                        >
                        and
                        <code class="docutils literal notranslate"
                          ><span class="pre">/dev/nst0</span></code
                        >
                        below with the device files found on your system. We’ll
                        be verifying them in the next section.
                      </p>
                      <div class="highlight-kconfig notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># /etc/bareos/bareos-sd.conf</span>
Storage<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-sd<span class="w"></span>
<span class="w">  </span>Maximum<span class="w"> </span>Concurrent<span class="w"> </span>Jobs<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"></span>
}<span class="w"></span>

Director<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-dir<span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
}<span class="w"></span>

Autochanger<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>PV-124T<span class="w"></span>
<span class="w">  </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>ULTRIUM-TD3<span class="w"></span>
<span class="w">  </span>Changer<span class="w"> </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>/dev/sg3<span class="w"></span>
<span class="w">  </span>Changer<span class="w"> </span>Command<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/usr/lib/bareos/scripts/mtx-changer %c %o %S %a %d&quot;</span><span class="w"></span>
}<span class="w"></span>

Device<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>ULTRIUM-TD3<span class="w"></span>
<span class="w">  </span>Media<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>LTO-3<span class="w"></span>
<span class="w">  </span>Archive<span class="w"> </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>/dev/nst0<span class="w"></span>
<span class="w">  </span>Autochanger<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">  </span>AutomaticMount<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">  </span>AlwaysOpen<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
}<span class="w"></span>

Device<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>FileStorage<span class="w"></span>
<span class="w">  </span>Media<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>File<span class="w"></span>
<span class="w">  </span>Archive<span class="w"> </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/bareos/tmp<span class="w"></span>
<span class="w">  </span>LabelMedia<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes;<span class="w"></span>
<span class="w">  </span>Random<span class="w"> </span>Access<span class="w"> </span><span class="o">=</span><span class="w"> </span>Yes;<span class="w"></span>
<span class="w">  </span>AutomaticMount<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes;<span class="w"></span>
<span class="w">  </span>RemovableMedia<span class="w"> </span><span class="o">=</span><span class="w"> </span>no;<span class="w"></span>
<span class="w">  </span>AlwaysOpen<span class="w"> </span><span class="o">=</span><span class="w"> </span>no;<span class="w"></span>
}<span class="w"></span>

Messages<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Standard<span class="w"></span>
<span class="w">  </span>director<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-dir<span class="w"> </span><span class="o">=</span><span class="w"> </span>all<span class="w"></span>
}<span class="w"></span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="verify-storage-config">
                      <h3>
                        Verify Storage Config<a
                          class="headerlink"
                          href="#verify-storage-config"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        Before we go any further we should make sure the storage
                        daemon configuration file is valid. We can easily test
                        this with the commands below. Load up a tape inside the
                        <strong>tape drive</strong> and another tape in
                        <strong>slot 1</strong> in your autoloader. I did this
                        using my autoloader’s web interface.
                      </p>
                      <p>
                        First we make sure the tape drive works. Substitute
                        <code class="docutils literal notranslate"
                          ><span class="pre">/dev/nst0</span></code
                        >
                        with what you have in the storage daemon config:
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo mt -f /dev/nst0 rewind
mkdir src dst <span class="o">&amp;&amp;</span> date &gt; ./src/date.txt
sudo tar -cvf /dev/nst0 src
sudo mt -f /dev/nst0 rewind
sudo tar -xvf /dev/nst0 -C dst
ls -lah src/ dst/src/<span class="p">;</span> cat src/date.txt dst/src/date.txt
</pre>
                        </div>
                      </div>
                      <p>
                        Next we’ll test the autoloader as well as the storage
                        daemon config:
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo mtx -f /dev/sg3 inquiry  <span class="c1"># Test autoloader.</span>
sudo btape /dev/nst0  <span class="c1"># Run &quot;test&quot; in the console.</span>
</pre>
                        </div>
                      </div>
                      <p>This is what I got when I ran those two commands:</p>
                      <div class="highlight-none notranslate">
                        <div class="highlight">
                          <pre><span></span>$ sudo mtx -f /dev/sg3 inquiry
Product Type: Medium Changer
Vendor ID: &#39;DELL    &#39;
Product ID: &#39;PV-124T         &#39;
Revision: &#39;0085&#39;
Attached Changer API: No
$ sudo btape /dev/nst0
Tape block granularity is 1024 bytes.
btape: butil.c:301-0 Using device: &quot;/dev/nst0&quot; for writing.
btape: btape.c:484-0 open device &quot;ULTRIUM-TD3&quot; (/dev/nst0): OK
*test

=== Write, rewind, and re-read test ===

I&#39;m going to write 10000 records and an EOF
then write 10000 records and an EOF, then rewind,
and re-read the data to verify that it is correct.

This is an *essential* feature ...

btape: btape.c:1171-0 Wrote 10000 blocks of 64412 bytes.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1187-0 Wrote 10000 blocks of 64412 bytes.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1229-0 Rewind OK.
10000 blocks re-read correctly.
Got EOF on tape.
10000 blocks re-read correctly.
=== Test Succeeded. End Write, rewind, and re-read test ===

btape: btape.c:1297-0 Block position test
btape: btape.c:1309-0 Rewind OK.
Reposition to file:block 0:4
Block 5 re-read correctly.
Reposition to file:block 0:200
Block 201 re-read correctly.
Reposition to file:block 0:9999
Block 10000 re-read correctly.
Reposition to file:block 1:0
Block 10001 re-read correctly.
Reposition to file:block 1:600
Block 10601 re-read correctly.
Reposition to file:block 1:9999
Block 20000 re-read correctly.
=== Test Succeeded. End Write, rewind, and re-read test ===



=== Append files test ===

This test is essential to Bareos.

I&#39;m going to write one record  in file 0,
                   two records in file 1,
             and three records in file 2

btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:484-0 open device &quot;ULTRIUM-TD3&quot; (/dev/nst0): OK
btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1441-0 Now moving to end of medium.
btape: btape.c:637-0 Moved to end of medium.
We should be in file 3. I am at file 3. This is correct!

Now the important part, I am going to attempt to append to the tape.

btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
Done appending, there should be no I/O errors

Doing Bareos scan of blocks:
1 block of 64448 bytes in file 1
End of File mark.
2 blocks of 64448 bytes in file 2
End of File mark.
3 blocks of 64448 bytes in file 3
End of File mark.
1 block of 64448 bytes in file 4
End of File mark.
Total files=4, blocks=7, bytes = 451,136
End scanning the tape.
We should be in file 4. I am at file 4. This is correct!

The above Bareos scan should have output identical to what follows.
Please double check it ...
=== Sample correct output ===
1 block of 64448 bytes in file 1
End of File mark.
2 blocks of 64448 bytes in file 2
End of File mark.
3 blocks of 64448 bytes in file 3
End of File mark.
1 block of 64448 bytes in file 4
End of File mark.
Total files=4, blocks=7, bytes = 451,136
=== End sample correct output ===

If the above scan output is not identical to the
sample output, you MUST correct the problem
or Bareos will not be able to write multiple Jobs to
the tape.


=== Write, backup, and re-read test ===

I&#39;m going to write three records and an EOF
then backup over the EOF and re-read the last record.
Bareos does this after writing the last block on the
tape to verify that the block was written correctly.

This is not an *essential* feature ...

btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:823-0 Wrote first record of 64412 bytes.
btape: btape.c:834-0 Wrote second record of 64412 bytes.
btape: btape.c:845-0 Wrote third record of 64412 bytes.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:861-0 Backspaced over EOF OK.
btape: btape.c:866-0 Backspace record OK.
btape: btape.c:884-0
Block re-read correct. Test succeeded!
=== End Write, backup, and re-read test ===



=== Forward space files test ===

This test is essential to Bareos.

I&#39;m going to write five files then test forward spacing

btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1928-0 Wrote one record of 64412 bytes.
btape: btape.c:1930-0 Wrote block to device.
btape: btape.c:616-0 Wrote 1 EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1655-0 Now forward spacing 1 file.
We should be in file 1. I am at file 1. This is correct!
btape: btape.c:1667-0 Now forward spacing 2 files.
We should be in file 3. I am at file 3. This is correct!
btape: btape.c:586-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1680-0 Now forward spacing 4 files.
We should be in file 4. I am at file 4. This is correct!

btape: btape.c:1698-0 Now forward spacing 1 more file.
We should be in file 5. I am at file 5. This is correct!

=== End Forward space files test ===


Ah, I see you have an autochanger configured.
To test the autochanger you must have a blank tape
 that I can write on in Slot 1.

Do you wish to continue with the Autochanger test? (y/n): y


=== Autochanger test ===

3301 Issuing autochanger &quot;loaded&quot; command.
Slot 1 loaded. I am going to unload it.
3302 Issuing autochanger &quot;unload 1 0&quot; command.
unload status=OK 0
3303 Issuing autochanger &quot;load 1 0&quot; command.
3303 Autochanger &quot;load 1 0&quot; status is OK.
btape: btape.c:484-0 open device &quot;ULTRIUM-TD3&quot; (/dev/nst0): OK
btape: btape.c:1585-0 Rewound &quot;ULTRIUM-TD3&quot; (/dev/nst0)
btape: btape.c:1592-0 Wrote EOF to &quot;ULTRIUM-TD3&quot; (/dev/nst0)

The test autochanger worked!!

*q
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="director-daemon-config">
                      <h3>
                        Director Daemon Config<a
                          class="headerlink"
                          href="#director-daemon-config"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        Finally we configure the Bareos director. I’ll be
                        defining three separate directories to backup. You may
                        substitute this for one directory or however many you
                        need. These directories will be owned by
                        <code class="docutils literal notranslate"
                          ><span class="pre">bareos:bareos</span></code
                        >
                        and will be populated remotely using
                        <code class="docutils literal notranslate"
                          ><span class="pre">rsync</span></code
                        >
                        (e.g. pushed from my OS X desktop computer).
                      </p>
                      <div class="admonition note">
                        <p class="admonition-title">Note</p>
                        <p>
                          The
                          <a
                            class="reference external"
                            href="http://doc.bareos.org/master/html/bareos-manual-main-reference.html#x1-730005.12"
                            >Bareos documentation</a
                          >
                          encourages you not to use
                          <code class="docutils literal notranslate"
                            ><span class="pre">localhost</span></code
                          >
                          in your configuration. Instead use the FQDN and make
                          sure you can resolve it properly.
                        </p>
                      </div>
                      <p>
                        We’ll be splitting up the director configuration into a
                        few files since otherwise it would be pretty big. If you
                        don’t like that you can just merge these into
                        <code class="docutils literal notranslate"
                          ><span class="pre">bareos-dir.conf</span></code
                        >
                        and it’ll work just the same.
                      </p>
                      <div class="highlight-kconfig notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># /etc/bareos/bareos-dir.d/filesets.conf  # chown bareos:bareos; chmod 0640</span>

<span class="c1"># Optional for testing the config.</span>
FileSet<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>SelfTest<span class="w"></span>
<span class="w">  </span>Include<span class="w"> </span>{<span class="w"></span>
<span class="w">    </span>Options<span class="w"> </span>{<span class="w"></span>
<span class="w">      </span>CheckFileChanges<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>NoATime<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>Signature<span class="w"> </span><span class="o">=</span><span class="w"> </span>SHA1<span class="w"></span>
<span class="w">      </span>Verify<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span>}<span class="w"></span>
<span class="w">    </span>File<span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/bareos/selftest<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>
}<span class="w"></span>

<span class="c1"># Required for the Bareos catalog backup.</span>
FileSet<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Catalog<span class="w"></span>
<span class="w">  </span>Include<span class="w"> </span>{<span class="w"></span>
<span class="w">    </span>Options<span class="w"> </span>{<span class="w"></span>
<span class="w">      </span>signature<span class="w"> </span><span class="o">=</span><span class="w"> </span>SHA1<span class="w"></span>
<span class="w">    </span>}<span class="w"></span>
<span class="w">    </span>File<span class="w"> </span><span class="o">=</span><span class="w"> </span>/var/lib/bareos/bareos.sql<span class="w"></span>
<span class="w">    </span>File<span class="w"> </span><span class="o">=</span><span class="w"> </span>/etc/bareos<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>
}<span class="w"></span>

<span class="c1"># Where I store my files.</span>
FileSet<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BoscoMain<span class="w"></span>
<span class="w">  </span>Include<span class="w"> </span>{<span class="w"></span>
<span class="w">    </span>Options<span class="w"> </span>{<span class="w"></span>
<span class="w">      </span>CheckFileChanges<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>NoATime<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>Signature<span class="w"> </span><span class="o">=</span><span class="w"> </span>SHA1<span class="w"></span>
<span class="w">      </span>Verify<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span>}<span class="w"></span>
<span class="w">    </span>File<span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/bareos/bosco/Main<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>
}<span class="w"></span>

<span class="c1"># Other files to backup.</span>
FileSet<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BoscoOld<span class="w"></span>
<span class="w">  </span>Include<span class="w"> </span>{<span class="w"></span>
<span class="w">    </span>Options<span class="w"> </span>{<span class="w"></span>
<span class="w">      </span>CheckFileChanges<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>NoATime<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">      </span>Signature<span class="w"> </span><span class="o">=</span><span class="w"> </span>SHA1<span class="w"></span>
<span class="w">      </span>Verify<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span>}<span class="w"></span>
<span class="w">    </span>File<span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/bareos/bosco/Old<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>
}<span class="w"></span>
</pre>
                        </div>
                      </div>
                      <div class="highlight-kconfig notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># /etc/bareos/bareos-dir.d/jobs.conf  # chown bareos:bareos; chmod 0640</span>

<span class="c1"># Default settings for a job.</span>
JobDefs<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>DefaultJob<span class="w"></span>
<span class="w">  </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>Backup<span class="w"></span>
<span class="w">  </span>Level<span class="w"> </span><span class="o">=</span><span class="w"> </span>Full<span class="w"></span>
<span class="w">  </span>Client<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-fd<span class="w"></span>
<span class="w">  </span>Storage<span class="w"> </span><span class="o">=</span><span class="w"> </span>Tape<span class="w"></span>
<span class="w">  </span>Messages<span class="w"> </span><span class="o">=</span><span class="w"> </span>Standard<span class="w"></span>
<span class="w">  </span>Pool<span class="w"> </span><span class="o">=</span><span class="w"> </span>Full<span class="w"></span>
<span class="w">  </span>Write<span class="w"> </span>Bootstrap<span class="w"> </span><span class="o">=</span><span class="w"> </span>/var/lib/bareos/%c.bsr<span class="w"></span>
}<span class="w"></span>

Job<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BackupSelfTest<span class="w"></span>
<span class="w">  </span>FileSet<span class="w"> </span><span class="o">=</span><span class="w"> </span>SelfTest<span class="w"></span>
<span class="w">  </span>JobDefs<span class="w"> </span><span class="o">=</span><span class="w"> </span>DefaultJob<span class="w"></span>
}<span class="w"></span>

Job<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BackupCatalog<span class="w"></span>
<span class="w">  </span>FileSet<span class="w"> </span><span class="o">=</span><span class="w"> </span>Catalog<span class="w"></span>
<span class="w">  </span>JobDefs<span class="w"> </span><span class="o">=</span><span class="w"> </span>DefaultJob<span class="w"></span>
<span class="w">  </span>RunBeforeJob<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/usr/lib/bareos/scripts/make_catalog_backup.pl Catalog&quot;</span><span class="w"></span>
<span class="w">  </span><span class="c1"># RunAfterJob  = /usr/lib/bareos/scripts/delete_catalog_backup</span>
<span class="w">  </span>Priority<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
}<span class="w"></span>

Job<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BackupBoscoMain<span class="w"></span>
<span class="w">  </span>FileSet<span class="w"> </span><span class="o">=</span><span class="w"> </span>BoscoMain<span class="w"></span>
<span class="w">  </span>JobDefs<span class="w"> </span><span class="o">=</span><span class="w"> </span>DefaultJob<span class="w"></span>
<span class="w">  </span>Priority<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
}<span class="w"></span>

Job<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>BackupBoscoOld<span class="w"></span>
<span class="w">  </span>FileSet<span class="w"> </span><span class="o">=</span><span class="w"> </span>BoscoOld<span class="w"></span>
<span class="w">  </span>JobDefs<span class="w"> </span><span class="o">=</span><span class="w"> </span>DefaultJob<span class="w"></span>
<span class="w">  </span>Priority<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
}<span class="w"></span>

<span class="c1"># Only one restore job is needed for all Jobs/Clients/Storage.</span>
Job<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>RestoreFiles<span class="w"></span>
<span class="w">  </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>Restore<span class="w"></span>
<span class="w">  </span>Client<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-fd<span class="w"></span>
<span class="w">  </span>FileSet<span class="w"> </span><span class="o">=</span><span class="w"> </span>BoscoMain<span class="w"></span>
<span class="w">  </span>Storage<span class="w"> </span><span class="o">=</span><span class="w"> </span>File<span class="w"></span>
<span class="w">  </span>Pool<span class="w"> </span><span class="o">=</span><span class="w"> </span>Full<span class="w"></span>
<span class="w">  </span>Messages<span class="w"> </span><span class="o">=</span><span class="w"> </span>Standard<span class="w"></span>
<span class="w">  </span>Where<span class="w"> </span><span class="o">=</span><span class="w"> </span>/home/bareos/tmp/restores<span class="w"></span>
}<span class="w"></span>
</pre>
                        </div>
                      </div>
                      <div class="highlight-kconfig notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># /etc/bareos/bareos-dir.conf</span>
@/etc/bareos/bareos-dir.d/filesets.conf<span class="w"></span>
@/etc/bareos/bareos-dir.d/jobs.conf<span class="w"></span>

Director<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-dir<span class="w"></span>
<span class="w">  </span>QueryFile<span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/lib/bareos/scripts/query.sql<span class="w"></span>
<span class="w">  </span>Maximum<span class="w"> </span>Concurrent<span class="w"> </span>Jobs<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w">  </span><span class="c1"># Console password</span>
<span class="w">  </span>Messages<span class="w"> </span><span class="o">=</span><span class="w"> </span>Daemon<span class="w"></span>
<span class="w">  </span>Auditing<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
}<span class="w"></span>

Client<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops-fd<span class="w"></span>
<span class="w">  </span>Address<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops.myhome.net<span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
}<span class="w"></span>

Storage<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Tape<span class="w"></span>
<span class="w">  </span>Address<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops.myhome.net<span class="w"></span>
<span class="w">  </span>Auto<span class="w"> </span>Changer<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
<span class="w">  </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>PV-124T<span class="w"></span>
<span class="w">  </span>Media<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>LTO-3<span class="w"></span>
}<span class="w"></span>

Storage<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>File<span class="w"></span>
<span class="w">  </span>Address<span class="w"> </span><span class="o">=</span><span class="w"> </span>moops.myhome.net<span class="w"></span>
<span class="w">  </span>Password<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
<span class="w">  </span>Device<span class="w"> </span><span class="o">=</span><span class="w"> </span>FileStorage<span class="w"></span>
<span class="w">  </span>Media<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>File<span class="w"></span>
}<span class="w"></span>

Catalog<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Catalog<span class="w"></span>
<span class="w">  </span>dbdriver<span class="w"> </span><span class="o">=</span><span class="w"> </span>mysql<span class="w"></span>
<span class="w">  </span>dbname<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
<span class="w">  </span>dbuser<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
<span class="w">  </span>dbpassword<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PUT_ORIGINAL_VALUE_HERE&quot;</span><span class="w"></span>
}<span class="w"></span>

Messages<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Standard<span class="w"></span>
<span class="w">  </span>console<span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>skipped,<span class="w"> </span><span class="o">!</span>saved,<span class="w"> </span><span class="o">!</span>audit<span class="w"></span>
<span class="w">  </span>append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/log/bareos/bareos.log&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>skipped,<span class="w"> </span><span class="o">!</span>audit<span class="w"></span>
<span class="w">  </span>catalog<span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>audit<span class="w"></span>
}<span class="w"></span>

Messages<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Daemon<span class="w"></span>
<span class="w">  </span>console<span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>skipped,<span class="w"> </span><span class="o">!</span>saved,<span class="w"> </span><span class="o">!</span>audit<span class="w"></span>
<span class="w">  </span>append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/log/bareos/bareos.log&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>all,<span class="w"> </span><span class="o">!</span>skipped,<span class="w"> </span><span class="o">!</span>audit<span class="w"></span>
<span class="w">  </span>append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/var/log/bareos/bareos-audit.log&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>audit<span class="w"></span>
}<span class="w"></span>

Pool<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Full<span class="w"></span>
<span class="w">  </span>AutoPrune<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">  </span>Label<span class="w"> </span>Format<span class="w"> </span><span class="o">=</span><span class="w"> </span>Full-<span class="w"></span>
<span class="w">  </span>Pool<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>Backup<span class="w"></span>
<span class="w">  </span>Recycle<span class="w"> </span><span class="o">=</span><span class="w"> </span>yes<span class="w"></span>
<span class="w">  </span>VolumeRetention<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span>d<span class="w"></span>
<span class="w">  </span>VolumeUseDuration<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>d<span class="w"></span>
}<span class="w"></span>

Pool<span class="w"> </span>{<span class="w"></span>
<span class="w">  </span>Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>Scratch<span class="w"></span>
<span class="w">  </span>Pool<span class="w"> </span>Type<span class="w"> </span><span class="o">=</span><span class="w"> </span>Backup<span class="w"></span>
}<span class="w"></span>
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="start-services">
                      <h3>
                        Start Services<a
                          class="headerlink"
                          href="#start-services"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>Everything should work.</p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>sudo systemctl start bareos-fd.service
sudo systemctl start bareos-sd.service
sudo systemctl start bareos-dir.service
sudo systemctl status bareos-fd.service
sudo systemctl status bareos-sd.service
sudo systemctl status bareos-dir.service
</pre>
                        </div>
                      </div>
                    </div>
                    <div class="section" id="test-everything">
                      <h3>
                        Test Everything<a
                          class="headerlink"
                          href="#test-everything"
                          title="Permalink to this headline"
                          >¶</a
                        >
                      </h3>
                      <p>
                        Here we’ll do a quick test. We’ll create a bunch of
                        files in
                        <code class="docutils literal notranslate"
                          ><span class="pre">/home/bareos/selftest</span></code
                        >
                        (defined in
                        <code class="docutils literal notranslate"
                          ><span class="pre"
                            >/etc/bareos/bareos-dir.d/filesets.conf</span
                          ></code
                        >) and back them up to one or two tapes. Then we’ll
                        restore them to
                        <code class="docutils literal notranslate"
                          ><span class="pre"
                            >/home/bareos/tmp/restores</span
                          ></code
                        >
                        (defined in
                        <code class="docutils literal notranslate"
                          ><span class="pre"
                            >/etc/bareos/bareos-dir.d/jobs.conf</span
                          ></code
                        >). We’ll compare them with
                        <code class="docutils literal notranslate"
                          ><span class="pre">sha1sum</span></code
                        >.
                      </p>
                      <div class="admonition tip">
                        <p class="admonition-title">Tip</p>
                        <p>
                          Since we’re starting with an empty Bareos database, it
                          will consider all tapes empty. Remove any tapes from
                          the autoloader that you don’t want overridden. You can
                          use my
                          <a
                            class="reference external"
                            href="https://github.com/Robpol86/tape_bulk_eject"
                            >tape_bulk_eject.py</a
                          >
                          tool to automate this.
                        </p>
                      </div>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span><span class="c1"># Create files.</span>
rm -rf /home/bareos/selftest<span class="p">;</span> mkdir /home/bareos/selftest
date <span class="p">|</span>tee /home/bareos/selftest/current_date.txt
openssl rand -base64 <span class="k">$((</span> <span class="m">2</span><span class="o">**</span><span class="m">30</span> <span class="o">*</span> <span class="m">3</span><span class="o">/</span><span class="m">4</span> <span class="o">*</span> <span class="m">2</span> <span class="k">))</span> -out /home/bareos/selftest/2_gb_random.bin
mkdir -p /home/bareos/selftest/subdir1/subdir2
<span class="o">(</span><span class="nb">cd</span> /home/bareos/selftest<span class="p">;</span> <span class="k">for</span> i <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..15<span class="o">}</span><span class="p">;</span> <span class="k">do</span> cat 2_gb_random.bin &gt;&gt; subdir1/subdir2/30_gb_random.bin<span class="p">;</span> <span class="k">done</span><span class="o">)</span>
find /home/bareos/selftest -type f -exec sha1sum <span class="o">{}</span> <span class="se">\+</span>

<span class="c1"># Backup through bconsole.</span>
sudo bconsole
</pre>
                        </div>
                      </div>
                      <p>
                        In the Bareos console we’ll type these commands to
                        backup the above files and then restore them to a
                        separate directory. Remove any tapes from the drive.
                      </p>
                      <div class="highlight-bash notranslate">
                        <div class="highlight">
                          <pre><span></span>update slots  <span class="c1"># Read the status of all slots in the autoloader.</span>
label barcodes  <span class="c1"># Initialize all tapes. Select Full pool. ETA 30 mins for 16 tapes.</span>
list volumes  <span class="c1"># Verify all tapes have been detected.</span>
run BackupSelfTest
status client  <span class="c1"># Check the status of the job. You can also run &quot;messages&quot;.</span>
restore  <span class="c1"># After backup is done do this. Follow the directions.</span>
q
</pre>
                        </div>
                      </div>
                      <p>
                        Finally run
                        <code class="docutils literal notranslate"
                          ><span class="pre">find</span>
                          <span class="pre"
                            >/home/bareos/tmp/restores/home/bareos/selftest/</span
                          >
                          <span class="pre">-type</span>
                          <span class="pre">f</span>
                          <span class="pre">-exec</span>
                          <span class="pre">sha1sum</span>
                          <span class="pre">{}</span>
                          <span class="pre">\+</span></code
                        >
                        and compare sha sums. You can test if your data is
                        actually encrypted by temporarily removing the PKI lines
                        from
                        <code class="docutils literal notranslate"
                          ><span class="pre">bareos-fd.conf</span></code
                        >
                        and running the
                        <code class="docutils literal notranslate"
                          ><span class="pre">restore</span></code
                        >
                        command again.
                      </p>
                    </div>
                  </div>
                  <div class="section" id="reusing-old-tapes">
                    <h2>
                      Reusing Old Tapes<a
                        class="headerlink"
                        href="#reusing-old-tapes"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>
                      Several years ago before Bareos I used Bacula. I consider
                      the data on my old tapes as disposable and I want to start
                      fresh. Unfortunately Bareos (and Bacula) doesn’t have an
                      easy way to reuse tapes. The best method I’ve found was to
                      manually wipe them. I run these commands:
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="c1"># Stop Bareos services.</span>
<span class="k">for</span> s <span class="k">in</span> dir sd fd<span class="p">;</span> <span class="k">do</span> sudo systemctl stop bareos-<span class="nv">$s</span>.service<span class="p">;</span> <span class="k">done</span>
<span class="c1"># Make sure drive is unlocked and unloaded. Also which slots tapes are in.</span>
sudo mtx -f /dev/sg3 status
<span class="c1"># Wipe selected tapes. Here {1..16} expands to all 16 slots.</span>
<span class="k">for</span> t <span class="k">in</span> <span class="o">{</span><span class="m">1</span>..16<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
    sudo mtx -f /dev/sg3 load <span class="nv">$t</span> <span class="m">0</span>
    sudo mt -f /dev/nst0 weof
    sudo mtx -f /dev/sg3 unload <span class="nv">$t</span> <span class="m">0</span>
<span class="k">done</span>
</pre>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="backing-up-data">
                    <h2>
                      Backing Up Data<a
                        class="headerlink"
                        href="#backing-up-data"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <p>These are the commands I run to backup my data.</p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="c1"># On the client.</span>
rsync -irtv --delete Main Old moops:/home/bareos/bosco
</pre>
                      </div>
                    </div>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="c1"># On the server.</span>
sudo su -c <span class="s1">&#39;for f in /sys/class/scsi_host/host*/scan; do echo &quot;- - -&quot; &gt; $f; done&#39;</span>
lsscsi -g  <span class="c1"># Verify autoloader and tape drive are present.</span>
sudo systemctl start mariadb.service
<span class="k">for</span> s <span class="k">in</span> fd sd dir<span class="p">;</span> <span class="k">do</span> sudo systemctl start bareos-<span class="nv">$s</span>.service<span class="p">;</span> <span class="k">done</span>
sudo mtx -f /dev/sg3 status  <span class="c1"># Verify tape drive (element 0) is empty.</span>
sudo bconsole
</pre>
                      </div>
                    </div>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="c1"># In bconsole on the server.</span>
update slots
<span class="c1"># New tapes: label slot=8,12,14-16 barcodes</span>
list volumes
run <span class="nv">job</span><span class="o">=</span>BackupBoscoMain
run <span class="nv">job</span><span class="o">=</span>BackupBoscoOld
run <span class="nv">job</span><span class="o">=</span>BackupCatalog
status client
</pre>
                      </div>
                    </div>
                    <p>
                      Once all three jobs finish (you can queue them up at the
                      same time) you’re done. I always eject all tapes and store
                      them off-site, so I run these commands within
                      <code class="docutils literal notranslate"
                        ><span class="pre">bconsole</span></code
                      >:
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>unmount Tape  <span class="c1"># Unloads the last tape from the drive.</span>
list <span class="nb">jobs</span>
list volumes <span class="nv">jobid</span><span class="o">=</span><span class="m">1</span> <span class="nv">jobid</span><span class="o">=</span><span class="m">2</span> <span class="nv">jobid</span><span class="o">=</span><span class="m">3</span>
</pre>
                      </div>
                    </div>
                    <p>
                      Finally you’ll want to backup your Bareos database
                      somewhere in case you need to restore the catalog on
                      another machine or if you lose your Bareos/MySQL server.
                      You only need to do this if you encrypt your tapes.
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span>sudo cat /var/lib/bareos/bareos.sql <span class="p">|</span>gzip -9 &gt; ~/bareos.sql.gz
sudo rm /var/lib/bareos/bareos.sql
</pre>
                      </div>
                    </div>
                    <p>
                      Then I use my
                      <a
                        class="reference external"
                        href="https://github.com/Robpol86/tape_bulk_eject"
                        >tape_bulk_eject.py</a
                      >
                      tool to eject all those tapes. I also stop all services
                      since I don’t leave my autoloader running all the time
                      (it’s too loud for my living room).
                    </p>
                    <div class="highlight-bash notranslate">
                      <div class="highlight">
                        <pre><span></span><span class="k">for</span> s <span class="k">in</span> dir sd fd<span class="p">;</span> <span class="k">do</span> sudo systemctl stop bareos-<span class="nv">$s</span>.service<span class="p">;</span> <span class="k">done</span>
sudo systemctl stop mariadb.service
./tape_bulk_eject.py <span class="s2">&quot;000039L3|000031L3&quot;</span> <span class="s2">&quot;000031L3|000021L3|000032L3|000033L3|000030L3&quot;</span>
</pre>
                      </div>
                    </div>
                  </div>
                  <div class="section" id="comments">
                    <h2>
                      Comments<a
                        class="headerlink"
                        href="#comments"
                        title="Permalink to this headline"
                        >¶</a
                      >
                    </h2>
                    <div
                      data-disqus-identifier="Bareos Tape Backup on a 124T"
                      data-disqus-shortname="rob86wiki"
                      id="disqus_thread"
                    ></div>
                  </div>
                </div>
              </div>

              <!-- Previous / next buttons -->
              <div class="prev-next-area">
                <a
                  class="left-prev"
                  id="prev-link"
                  href="postfix_gmail_forwarding.html"
                  title="previous page"
                >
                  <i class="fas fa-angle-left"></i>
                  <div class="prev-next-info">
                    <p class="prev-next-subtitle">previous</p>
                    <p class="prev-next-title">Postfix and Gmail Forwarding</p>
                  </div>
                </a>
                <a
                  class="right-next"
                  id="next-link"
                  href="flash_droid_cricket.html"
                  title="next page"
                >
                  <div class="prev-next-info">
                    <p class="prev-next-subtitle">next</p>
                    <p class="prev-next-title">
                      Flashing Motorola Droid to Cricket
                    </p>
                  </div>
                  <i class="fas fa-angle-right"></i>
                </a>
              </div>
            </div>
          </div>
          <footer class="footer">
            <p>
              &copy; Copyright 2022, Robpol86.<br />
              Last updated on Jan 23, 2022, 1:28:06 AM UTC.<br />
            </p>
          </footer>
        </main>
      </div>
    </div>

    <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>
  </body>
</html>
